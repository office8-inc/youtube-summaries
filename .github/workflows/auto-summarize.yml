name: Auto Summarize YouTube Videos

on:
  schedule:
    # æ¯Žæ—¥æ—¥æœ¬æ™‚é–“03:00ã«å®Ÿè¡Œï¼ˆUTC 18:00ï¼‰
    - cron: '0 18 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  summarize-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Create .env file
        run: |
          echo "YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}" >> .env
          echo "FTP_HOST=${{ secrets.FTP_HOST }}" >> .env
          echo "FTP_USER=${{ secrets.FTP_USER }}" >> .env
          echo "FTP_PASSWORD=${{ secrets.FTP_PASSWORD }}" >> .env
          echo "FTP_PORT=${{ secrets.FTP_PORT }}" >> .env
          echo "FTP_REMOTE_PATH=${{ secrets.FTP_REMOTE_PATH }}" >> .env
          echo "GH_TOKEN=${{ secrets.GH_TOKEN }}" >> .env
          echo "GITHUB_REPO=${{ github.repository }}" >> .env
          echo "MAX_VIDEOS_PER_DAY=10" >> .env
          echo "TIMEZONE=Asia/Tokyo" >> .env
      
      - name: Fetch new videos
        run: |
          python python/fetch_videos.py
      
      - name: Process videos and create summaries
        run: |
          python python/process_videos.py
      
      - name: Upload to FTP
        run: |
          python python/upload_to_ftp.py
      
      - name: Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add -A
          git diff --quiet && git diff --staged --quiet || git commit -m "ðŸ¤– è‡ªå‹•è¦ç´„: $(date +'%Y-%m-%d %H:%M JST')"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f process_results.json ]; then
            echo "å‡¦ç†çµæžœã®è©³ç´°ã¯ process_results.json ã‚’ç¢ºèªã—ã¦ãã ã•ã„" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰çµ±è¨ˆæƒ…å ±ã‚’æŠ½å‡º
            TOTAL=$(jq 'length' process_results.json)
            NEEDS_REVIEW=$(jq '[.[] | select(.result.needs_review == true)] | length' process_results.json)
            OK=$((TOTAL - NEEDS_REVIEW))
            
            echo "- å‡¦ç†å‹•ç”»æ•°: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- ãƒ¬ãƒ“ãƒ¥ãƒ¼å¿…è¦: $NEEDS_REVIEW" >> $GITHUB_STEP_SUMMARY
            echo "- å•é¡Œãªã—: $OK" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æ–°ç€å‹•ç”»ã¯ã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸ" >> $GITHUB_STEP_SUMMARY
          fi
