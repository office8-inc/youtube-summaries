name: Copilot Improve Summaries

on:
  push:
    branches:
      - main
    paths:
      - 'xserver/summaries/**/*.md'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-improvement-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã™ã‚‹ãŸã‚
      
      - name: Get changed summary files
        id: changed-files
        run: |
          # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã—ã¦è¿½åŠ ãƒ»å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD -- 'xserver/summaries/**/*.md' | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          if [ -z "$CHANGED_FILES" ]; then
            echo "count=0" >> $GITHUB_OUTPUT
          else
            echo "count=$(echo $CHANGED_FILES | wc -w)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create issue and assign to Copilot
        if: steps.changed-files.outputs.count > 0
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒªã‚¹ãƒˆã‚’ä½œæˆ
          FILES="${{ steps.changed-files.outputs.files }}"
          
          # Issueæœ¬æ–‡ã‚’ä½œæˆï¼ˆè¤‡æ•°è¡Œæ–‡å­—åˆ—ï¼‰
          cat > issue_body.md << 'EOF'
## ðŸ“ è¦ç´„è¨˜äº‹ã®æ”¹å–„ã‚¿ã‚¹ã‚¯

ä»¥ä¸‹ã®YouTubeè¦ç´„è¨˜äº‹ãŒæ–°è¦ä½œæˆã•ã‚Œã¾ã—ãŸã€‚æ—¥æœ¬èªžã®è³ªã‚’å‘ä¸Šã•ã›ã€èª­è€…ã«ã¨ã£ã¦ã‚ˆã‚Šä¾¡å€¤ã®ã‚ã‚‹å†…å®¹ã«æ”¹å–„ã—ã¦ãã ã•ã„ã€‚

### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«
EOF
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
          for file in $FILES; do
            echo "- \`$file\`" >> issue_body.md
          done
          
          # æ®‹ã‚Šã®æœ¬æ–‡ã‚’è¿½åŠ 
          cat >> issue_body.md << 'EOF'

### æ”¹å–„é …ç›®

#### 1. æ—¥æœ¬èªžã®è‡ªç„¶ã•å‘ä¸Š
- âœ… æ©Ÿæ¢°ç¿»è¨³ç‰¹æœ‰ã®ä¸è‡ªç„¶ãªè¡¨ç¾ã‚’ä¿®æ­£
- âœ… ã‚ˆã‚Šèª­ã¿ã‚„ã™ãã€æµæš¢ãªæ—¥æœ¬èªžã«æ›¸ãç›´ã™
- âœ… å°‚é–€ç”¨èªžã¯é©åˆ‡ãªæ—¥æœ¬èªžè¨³ã‚’ä½¿ç”¨ï¼ˆã‚«ã‚¿ã‚«ãƒŠè¡¨è¨˜ã®å ´åˆã¯åˆå‡ºæ™‚ã«è‹±èªžã‚’ä½µè¨˜ï¼‰

#### 2. æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¿½åŠ 
å„è¨˜äº‹ã®å†’é ­ã«ä»¥ä¸‹ã‚’å«ã‚€æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
- å‹•ç”»ã®ä¸»ãªãƒ†ãƒ¼ãƒžï¼ˆ2-3æ–‡ï¼‰
- æƒ³å®šè¦–è´æ™‚é–“
- å¯¾è±¡èª­è€…ï¼ˆä¾‹ï¼šåˆå¿ƒè€…å‘ã‘ã€é–‹ç™ºè€…å‘ã‘ãªã©ï¼‰

#### 3. é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
å„è¨˜äº‹ã«é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¦ãã ã•ã„
- 3-5å€‹ã®ç®‡æ¡æ›¸ãã§ã€å‹•ç”»ã®æ ¸å¿ƒçš„ãªå­¦ã³ã‚„è¦ç‚¹ã‚’ã¾ã¨ã‚ã‚‹
- å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚„TipsãŒã‚ã‚Œã°å¼·èª¿

#### 4. æ§‹é€ ã®æœ€é©åŒ–
- è¦‹å‡ºã—ã®éšŽå±¤ã‚’è¦‹ç›´ã—ã€èª­ã¿ã‚„ã™ã„æ§‹æˆã«
- é•·ã™ãŽã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯é©åˆ‡ã«åˆ†å‰²
- é–¢é€£ã™ã‚‹å†…å®¹ã‚’ã‚°ãƒ«ãƒ¼ãƒ—åŒ–

### æ³¨æ„äº‹é …
- æ—¢å­˜ã®çµµæ–‡å­—ã¯ä¿æŒã—ã¦ãã ã•ã„
- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ãƒãƒ£ãƒ³ãƒãƒ«åã€è¦–è´å›žæ•°ãªã©ï¼‰ã¯å¤‰æ›´ã—ãªã„ã§ãã ã•ã„
- å…ƒã®å†…å®¹ã®æ„å›³ã‚’å¤‰ãˆãªã„ã‚ˆã†ã«ã—ã¦ãã ã•ã„
- ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã‚’ç¶­æŒã—ã¦ãã ã•ã„

### å®Œäº†æ¡ä»¶
- ã™ã¹ã¦ã®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ”¹å–„ã•ã‚Œã¦ã„ã‚‹
- æ—¥æœ¬èªžãŒè‡ªç„¶ã§èª­ã¿ã‚„ã™ã„
- æ¦‚è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- ãƒžãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã®æ›¸å¼ãŒæ­£ã—ã„
EOF
          
          # Issueæœ¬æ–‡ã‚’èª­ã¿è¾¼ã‚“ã§JSONã‚¨ã‚¹ã‚±ãƒ¼ãƒ—
          ISSUE_BODY_JSON=$(cat issue_body.md | jq -R -s .)
          
          # Issueã‚’Copilotã«ã‚¢ã‚µã‚¤ãƒ³ã—ã¦ä½œæˆ
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            /repos/${{ github.repository }}/issues \
            --input - <<PAYLOAD
          {
            "title": "ðŸ¤– è¦ç´„è¨˜äº‹ã®æ”¹å–„: $(date +'%Y-%m-%d %H:%M')",
            "body": $ISSUE_BODY_JSON,
            "assignees": ["copilot-swe-agent[bot]"],
            "labels": ["copilot-task", "content-improvement"],
            "agent_assignment": {
              "target_repo": "${{ github.repository }}",
              "base_branch": "main",
              "custom_instructions": "æ—¥æœ¬èªžã®è¨˜äº‹ã¨ã—ã¦é«˜å“è³ªãªå†…å®¹ã«ä»•ä¸Šã’ã¦ãã ã•ã„ã€‚èª­è€…ã«ã¨ã£ã¦ä¾¡å€¤ã®ã‚ã‚‹ã€ã‚ã‹ã‚Šã‚„ã™ã„è¨˜äº‹ã‚’ç›®æŒ‡ã—ã¦ãã ã•ã„ã€‚",
              "custom_agent": "",
              "model": ""
            }
          }
          PAYLOAD
          
          echo "âœ… Copilotã«ã‚¿ã‚¹ã‚¯ã‚’ã‚¢ã‚µã‚¤ãƒ³ã—ã¾ã—ãŸ"
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š å®Ÿè¡Œçµæžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.changed-files.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changed-files.outputs.count }}" -gt "0" ]; then
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… Copilotã«ã‚¿ã‚¹ã‚¯ã‚’ã‚¢ã‚µã‚¤ãƒ³ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
            for file in ${{ steps.changed-files.outputs.files }}; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: â„¹ï¸ æ–°è¦è¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          fi
