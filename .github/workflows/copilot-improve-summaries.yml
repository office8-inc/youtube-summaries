name: Copilot Improve Summaries

on:
  push:
    branches:
      - main
    paths:
      - 'xserver/summaries/**/*.md'

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-improvement-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã™ã‚‹ãŸã‚
      
      - name: Check if pushed by Copilot
        id: check-author
        run: |
          # æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆä½œæˆè€…ã‚’ç¢ºèª
          COMMIT_AUTHOR=$(git log -1 --pretty=format:'%an')
          echo "Commit author: $COMMIT_AUTHOR"
          
          # å¤§æ–‡å­—ãƒ»å°æ–‡å­—ã‚’åŒºåˆ¥ã›ãšã«ãƒã‚§ãƒƒã‚¯
          COMMIT_AUTHOR_LOWER=$(echo "$COMMIT_AUTHOR" | tr '[:upper:]' '[:lower:]')
          
          # Copilotã¾ãŸã¯GitHub Actionsã«ã‚ˆã‚‹ã‚³ãƒŸãƒƒãƒˆã®å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [[ "$COMMIT_AUTHOR_LOWER" == *"copilot"* ]] || [[ "$COMMIT_AUTHOR_LOWER" == *"github-actions"* ]] || [[ "$COMMIT_AUTHOR_LOWER" == *"bot"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Copilotã¾ãŸã¯botã«ã‚ˆã‚‹ã‚³ãƒŸãƒƒãƒˆãªã®ã§ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™: $COMMIT_AUTHOR"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚‹ã‚³ãƒŸãƒƒãƒˆã§ã™: $COMMIT_AUTHOR"
          fi
      
      - name: Get changed summary files
        id: changed-files
        if: steps.check-author.outputs.skip != 'true'
        run: |
          # å‰ã®ã‚³ãƒŸãƒƒãƒˆã¨æ¯”è¼ƒã—ã¦è¿½åŠ ãƒ»å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
          CHANGED_FILES=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD -- 'xserver/summaries/**/*.md' | tr '\n' ' ')
          echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "Changed files: $CHANGED_FILES"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          if [ -z "$CHANGED_FILES" ]; then
            echo "count=0" >> $GITHUB_OUTPUT
          else
            echo "count=$(echo $CHANGED_FILES | wc -w)" >> $GITHUB_OUTPUT
          fi
      
      - name: Create branch, PR and assign to Copilot
        if: steps.check-author.outputs.skip != 'true' && steps.changed-files.outputs.count > 0
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          FILES="${{ steps.changed-files.outputs.files }}"
          TIMESTAMP=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="copilot/improve-summaries-${TIMESTAMP}"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’ä½œæˆ
          FILE_LIST=$(echo "$FILES" | tr ' ' '\n' | sed 's/^/- `/' | sed 's/$/`/')
          
          # ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ã€Pythonã§ç½®æ›
          export FILE_LIST
          ISSUE_BODY=$(python3 -c "import os; template = open('.github/ISSUE_TEMPLATE/copilot-improve-summary.md', 'r', encoding='utf-8').read(); print(template.replace('REPLACE_WITH_FILES', os.environ['FILE_LIST']))")
          
          # Issueã‚’ä½œæˆ
          ISSUE_TITLE="ğŸ¤– è¦ç´„è¨˜äº‹ã®æ”¹å–„: $(date +'%Y-%m-%d %H:%M')"
          ISSUE_URL=$(gh issue create --title "$ISSUE_TITLE" --body "$ISSUE_BODY" --label "copilot-task,content-improvement")
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -oP '/\d+$' | tr -d '/')
          echo "âœ… Issue #$ISSUE_NUMBER ä½œæˆ: $ISSUE_URL"
          
          # ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒä½œæˆ: $BRANCH_NAME"
          
          # PRã‚’ä½œæˆï¼ˆReadyçŠ¶æ…‹ã§ï¼‰
          PR_BODY="Closes #${ISSUE_NUMBER}\n\n@copilot ã“ã®è¦ç´„è¨˜äº‹ã‚’æ”¹å–„ã—ã¦ãã ã•ã„ã€‚æ—¥æœ¬èªã®æ–‡ç« ã¨ã—ã¦è‡ªç„¶ã§èª­ã¿ã‚„ã™ã„è¡¨ç¾ã«ä¿®æ­£ã—ã€é‡è¦ãªãƒã‚¤ãƒ³ãƒˆã‚’å¼·èª¿ã—ã¦ãã ã•ã„ã€‚\n\nä½œæ¥­å®Œäº†å¾Œã€è‡ªå‹•çš„ã«æ‰¿èªãƒ»ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚"
          PR_URL=$(gh pr create \
            --title "$ISSUE_TITLE" \
            --body "$PR_BODY" \
            --base main \
            --head "$BRANCH_NAME" \
            --label "copilot-task")
          PR_NUMBER=$(echo "$PR_URL" | grep -oP '/\d+$' | tr -d '/')
          echo "âœ… PR #$PR_NUMBER ä½œæˆï¼ˆReadyçŠ¶æ…‹ï¼‰: $PR_URL"
          
          # Copilotã‚’PRã«ã‚¢ã‚µã‚¤ãƒ³
          gh api \
            --method POST \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "/repos/${{ github.repository }}/issues/$PR_NUMBER/assignees" \
            --input - <<EOF || echo "âš ï¸ Copilotã®è‡ªå‹•ã‚¢ã‚µã‚¤ãƒ³ã«å¤±æ•—ï¼ˆPRæœ¬æ–‡ã®@copilotãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã§èµ·å‹•ã—ã¾ã™ï¼‰"
          {
            "assignees": ["copilot-swe-agent[bot]"],
            "agent_assignment": {
              "target_repo": "${{ github.repository }}",
              "base_branch": "main",
              "custom_instructions": "",
              "custom_agent": "",
              "model": ""
            }
          }
          EOF
          
          echo "âœ… Copilotä½œæ¥­ç’°å¢ƒã®æº–å‚™å®Œäº†"
          echo "  - Issue: #$ISSUE_NUMBER"
          echo "  - PR: #$PR_NUMBER (ReadyçŠ¶æ…‹)"
          echo "  - ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
      
      - name: Summary
        if: always()
        run: |
          echo "## ğŸ“Š å®Ÿè¡Œçµæœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æ¤œå‡ºãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.changed-files.outputs.count }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.changed-files.outputs.count }}" -gt "0" ]; then
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: âœ… Copilotã«ã‚¿ã‚¹ã‚¯ã‚’ã‚¢ã‚µã‚¤ãƒ³ã—ã¾ã—ãŸ" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«" >> $GITHUB_STEP_SUMMARY
            for file in ${{ steps.changed-files.outputs.files }}; do
              echo "- \`$file\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: â„¹ï¸ æ–°è¦è¦ç´„ãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“" >> $GITHUB_STEP_SUMMARY
          fi
