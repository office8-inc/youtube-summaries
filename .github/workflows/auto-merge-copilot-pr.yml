name: Auto Merge Copilot PR

on:
  pull_request_target:
    types: [opened, synchronize]
    paths:
      - 'xserver/summaries/**/*.md'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    # CopilotãŒä½œæˆã—ãŸPRã®ã¿è‡ªå‹•ãƒãƒ¼ã‚¸
    if: |
      github.event.pull_request.user.login == 'github-actions[bot]' ||
      github.event.pull_request.user.login == 'app/copilot-swe-agent' ||
      contains(github.event.pull_request.title, 'Copilot') ||
      contains(github.event.pull_request.title, 'è¦ç´„è¨˜äº‹ã®å“è³ªå‘ä¸Š')
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for Copilot to finish
        run: sleep 10
      
      - name: Check and fix Draft PR
        id: pr-check
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # PRã®çŠ¶æ…‹ã‚’ç¢ºèª
          PR_INFO=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json state,isDraft)
          PR_STATE=$(echo "$PR_INFO" | jq -r '.state')
          IS_DRAFT=$(echo "$PR_INFO" | jq -r '.isDraft')
          
          echo "PRçŠ¶æ…‹: $PR_STATE"
          echo "Draft: $IS_DRAFT"
          
          if [ "$PR_STATE" != "OPEN" ]; then
            echo "PRãŒã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # Draft PRã®å ´åˆã¯è‡ªå‹•çš„ã« Ready for review ã«å¤‰æ›´
          if [ "$IS_DRAFT" = "true" ]; then
            echo "ğŸ“ Draft PRã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚Ready for review ã«å¤‰æ›´ã—ã¾ã™..."
            gh pr ready $PR_NUMBER --repo ${{ github.repository }}
            echo "âœ“ PRã‚’ReadyçŠ¶æ…‹ã«å¤‰æ›´ã—ã¾ã—ãŸ"
            
            # Draftè§£é™¤å¾Œã€å°‘ã—å¾…æ©Ÿï¼ˆGitHub APIã®åæ˜ å¾…ã¡ï¼‰
            sleep 5
          fi
      
      - name: Auto approve PR
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "âœ… PRã‚’è‡ªå‹•æ‰¿èªã—ã¾ã™: #$PR_NUMBER"
          
          # Personal Access Tokenã§æ‰¿èª
          gh pr review $PR_NUMBER \
            --repo ${{ github.repository }} \
            --approve \
            --body "âœ… Copilotã«ã‚ˆã‚‹æ”¹å–„ã‚’è‡ªå‹•æ‰¿èªã—ã¾ã—ãŸã€‚FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚"
      
      - name: Auto merge PR
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "ğŸ”€ PRã‚’è‡ªå‹•ãƒãƒ¼ã‚¸ã—ã¾ã™: #$PR_NUMBER"
          
          # squashãƒãƒ¼ã‚¸ã§å±¥æ­´ã‚’ç¶ºéº—ã«ä¿ã¤
          gh pr merge $PR_NUMBER \
            --repo ${{ github.repository }} \
            --squash \
            --auto \
            --delete-branch
          
          echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸ"
          echo "ğŸ“¤ deploy-to-ftp ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™"
