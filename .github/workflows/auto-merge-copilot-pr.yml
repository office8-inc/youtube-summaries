name: Auto Approve and Merge Copilot PR

on:
  workflow_run:
    workflows: ["Copilot coding agent"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-approve-and-merge:
    # Copilot coding agentãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Find Copilot PR
        id: find-pr
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "ğŸ” Copilotä½œæ¥­å®Œäº†ã€‚é–¢é€£PRã‚’æ¤œç´¢..."
          
          # Copilotãƒ–ãƒ©ãƒ³ãƒã®æœªãƒãƒ¼ã‚¸PRã‚’æ¤œç´¢ï¼ˆæœ€æ–°1ä»¶ï¼‰
          PR_INFO=$(gh pr list --repo ${{ github.repository }} --state open --json number,headRefName,isDraft \
            | jq -r '[.[] | select(.headRefName | startswith("copilot/"))] | .[0]')
          
          if [ "$PR_INFO" = "null" ] || [ -z "$PR_INFO" ]; then
            echo "âš ï¸ Copilot PRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi
          
          PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
          IS_DRAFT=$(echo "$PR_INFO" | jq -r '.isDraft')
          
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "is_draft=$IS_DRAFT" >> $GITHUB_OUTPUT
          echo "âœ… PR #$PR_NUMBER ã‚’æ¤œå‡º (Draft: $IS_DRAFT)"
      
      - name: Auto approve PR
        if: steps.find-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ steps.find-pr.outputs.pr_number }}
        run: |
          echo "âœ… PRã‚’è‡ªå‹•æ‰¿èªã—ã¾ã™: #$PR_NUMBER"
          gh pr review $PR_NUMBER \
            --repo ${{ github.repository }} \
            --approve \
            --body "âœ… Copilot coding agentã®ä½œæ¥­å®Œäº†ã‚’ç¢ºèªã€‚è‡ªå‹•æ‰¿èªã—ã¾ã—ãŸã€‚"
          
          echo "âœ“ æ‰¿èªå®Œäº†"
          
      - name: Auto merge PR
        if: steps.find-pr.outputs.pr_number != ''
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          PR_NUMBER: ${{ steps.find-pr.outputs.pr_number }}
        run: |
          echo "ğŸ”€ PRã‚’è‡ªå‹•ãƒãƒ¼ã‚¸ã—ã¾ã™: #$PR_NUMBER"
          
          # ç›´æ¥ãƒãƒ¼ã‚¸ã‚’è©¦è¡Œ
          if gh pr merge $PR_NUMBER \
            --repo ${{ github.repository }} \
            --squash \
            --delete-branch; then
            echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸å®Œäº†"
          else
            # å¤±æ•—ã—ãŸå ´åˆã¯auto-mergeã‚’æœ‰åŠ¹åŒ–
            echo "âš ï¸ ç›´æ¥ãƒãƒ¼ã‚¸å¤±æ•—ã€‚auto-mergeã‚’æœ‰åŠ¹åŒ–ã—ã¾ã™..."
            gh pr merge $PR_NUMBER \
              --repo ${{ github.repository }} \
              --auto \
              --squash \
              --delete-branch
            echo "âœ“ Auto-mergeæœ‰åŠ¹åŒ–å®Œäº†ï¼ˆæ¡ä»¶ã‚’æº€ãŸã—æ¬¡ç¬¬è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼‰"
          fi

