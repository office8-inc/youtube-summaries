name: Auto Merge Copilot PR

on:
  pull_request_target:
    types: [ready_for_review, synchronize]  # Draft PRã®ã‚³ãƒŸãƒƒãƒˆæ™‚ã¨ReadyåŒ–æ™‚ã«å®Ÿè¡Œ
    paths:
      - 'xserver/summaries/**/*.md'

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    # Copilotãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ã®PRã®ã¿è‡ªå‹•ãƒãƒ¼ã‚¸ï¼ˆã‚ˆã‚Šç¢ºå®Ÿãªåˆ¤å®šï¼‰
    if: contains(github.event.pull_request.head.ref, 'copilot/')
    runs-on: ubuntu-latest
    
    steps:
      - name: Wait for Copilot to finish
        run: sleep 10
      
      - name: Check and fix Draft PR
        id: pr-check
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          # PRã®çŠ¶æ…‹ã¨æœ€æ–°ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã‚’ç¢ºèª
          PR_INFO=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json state,isDraft,commits)
          PR_STATE=$(echo "$PR_INFO" | jq -r '.state')
          IS_DRAFT=$(echo "$PR_INFO" | jq -r '.isDraft')
          LATEST_COMMIT_MESSAGE=$(echo "$PR_INFO" | jq -r '.commits[-1].messageHeadline')
          
          echo "PRçŠ¶æ…‹: $PR_STATE"
          echo "Draft: $IS_DRAFT"
          echo "æœ€æ–°ã‚³ãƒŸãƒƒãƒˆ: $LATEST_COMMIT_MESSAGE"
          
          if [ "$PR_STATE" != "OPEN" ]; then
            echo "PRãŒã‚ªãƒ¼ãƒ—ãƒ³çŠ¶æ…‹ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
            exit 1
          fi
          
          # Draft PRã‹ã¤CopilotãŒä½œæ¥­å®Œäº†ã—ã¦ã„ã‚‹å ´åˆã®ã¿è‡ªå‹•ReadyåŒ–
          if [ "$IS_DRAFT" = "true" ]; then
            # Copilotå®Œäº†ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆã€Œå®Œäº†ã€ã€Œfinishã€ã€Œæ”¹å–„å®Œäº†ã€ãªã©ï¼‰
            if echo "$LATEST_COMMIT_MESSAGE" | grep -qiE '(å®Œäº†|finish|improved|enhanced|optimized)'; then
              echo "ğŸ“ Copilotã®ä½œæ¥­å®Œäº†ã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚Ready for reviewã«å¤‰æ›´ã—ã¾ã™..."
              gh pr ready $PR_NUMBER --repo ${{ github.repository }}
              echo "âœ“ PRã‚’ReadyçŠ¶æ…‹ã«å¤‰æ›´ã—ã¾ã—ãŸ"
              
              # Draftè§£é™¤å¾Œã€å°‘ã—å¾…æ©Ÿï¼ˆGitHub APIã®åæ˜ å¾…ã¡ï¼‰
              sleep 5
            else
              echo "âš ï¸ Draft PRã§ã™ãŒã€Copilotä½œæ¥­ä¸­ã®ãŸã‚å¾…æ©Ÿã—ã¾ã™"
              exit 0
            fi
          fi
      
      - name: Auto approve and merge PR
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN || github.token }}
        run: |
          PR_NUMBER="${{ github.event.pull_request.number }}"
          
          echo "âœ… PRã‚’è‡ªå‹•æ‰¿èªã—ã¾ã™: #$PR_NUMBER"
          
          # Personal Access Tokenã§æ‰¿èªï¼ˆå¤±æ•—ã—ã¦ã‚‚ç¶šè¡Œï¼‰
          gh pr review $PR_NUMBER \
            --repo ${{ github.repository }} \
            --approve \
            --body "âœ… Copilotã«ã‚ˆã‚‹æ”¹å–„ã‚’è‡ªå‹•æ‰¿èªã—ã¾ã—ãŸã€‚FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚" || echo "âš ï¸ æ‰¿èªã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆRulesetã§ãƒã‚¤ãƒ‘ã‚¹è¨­å®šæ¸ˆã¿ï¼‰"
          
          echo ""
          echo "ğŸ”€ PRã‚’è‡ªå‹•ãƒãƒ¼ã‚¸ã—ã¾ã™: #$PR_NUMBER"
          
          # Rulesetãƒã‚¤ãƒ‘ã‚¹æ¨©é™ã§ãƒãƒ¼ã‚¸ï¼ˆCopilot coding agentã«æ¨©é™ä»˜ä¸æ¸ˆã¿ï¼‰
          if gh pr merge $PR_NUMBER \
            --repo ${{ github.repository }} \
            --squash \
            --delete-branch; then
            echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸ"
            echo "ğŸ“¤ deploy-to-ftp ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãƒˆãƒªã‚¬ãƒ¼ã•ã‚Œã¾ã™"
          else
            echo "âš ï¸ ç›´æ¥ãƒãƒ¼ã‚¸å¤±æ•—ã€auto-mergeã‚’è©¦è¡Œ..."
            # auto-mergeã§å¾…æ©Ÿãƒãƒ¼ã‚¸ï¼ˆãƒã‚§ãƒƒã‚¯å®Œäº†å¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸ï¼‰
            gh pr merge $PR_NUMBER \
              --repo ${{ github.repository }} \
              --auto \
              --squash \
              --delete-branch && echo "âœ… Auto-mergeã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆãƒã‚§ãƒƒã‚¯å®Œäº†å¾Œã«è‡ªå‹•ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ï¼‰"
          fi
