name: Auto Merge Copilot PR

on:
  workflow_run:
    workflows: ["Copilot coding agent"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    # Copilot coding agentãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Find and process Copilot PR
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          echo "ğŸ” Copilot coding agentå®Œäº†ã€‚é–¢é€£PRã‚’æ¤œç´¢..."
          
          # Copilotãƒ–ãƒ©ãƒ³ãƒã®æœªãƒãƒ¼ã‚¸PRã‚’æ¤œç´¢ï¼ˆæœ€æ–°1ä»¶ã®ã¿ï¼‰
          PR_INFO=$(gh pr list --repo ${{ github.repository }} --state open --json number,headRefName,isDraft \
            | jq -r '[.[] | select(.headRefName | startswith("copilot/"))] | .[0]')
          
          if [ "$PR_INFO" = "null" ] || [ -z "$PR_INFO" ]; then
            echo "âš ï¸ Copilot PRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi
          
          PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
          IS_DRAFT=$(echo "$PR_INFO" | jq -r '.isDraft')
          
          echo "PR #$PR_NUMBER ã‚’æ¤œå‡º (Draft: $IS_DRAFT)"
          
          # Draft PRã®å ´åˆã¯ReadyåŒ–
          if [ "$IS_DRAFT" = "true" ]; then
            echo "ğŸ“ Draft PRã‚’Ready for Reviewã«å¤‰æ›´..."
            gh pr ready $PR_NUMBER --repo ${{ github.repository }}
            echo "âœ“ ReadyçŠ¶æ…‹ã«å¤‰æ›´ã—ã¾ã—ãŸ"
            sleep 5
          fi
          
          # PRã‚’è‡ªå‹•æ‰¿èª
          echo "âœ… PRã‚’è‡ªå‹•æ‰¿èªã—ã¾ã™: #$PR_NUMBER"
          gh pr review $PR_NUMBER \
            --repo ${{ github.repository }} \
            --approve \
            --body "âœ… Copilotã«ã‚ˆã‚‹æ”¹å–„ã‚’è‡ªå‹•æ‰¿èªã—ã¾ã—ãŸã€‚" || echo "âš ï¸ æ‰¿èªã‚’ã‚¹ã‚­ãƒƒãƒ—"
          
          # PRã‚’è‡ªå‹•ãƒãƒ¼ã‚¸
          echo "ğŸ”€ PRã‚’è‡ªå‹•ãƒãƒ¼ã‚¸ã—ã¾ã™: #$PR_NUMBER"
          if gh pr merge $PR_NUMBER \
            --repo ${{ github.repository }} \
            --squash \
            --delete-branch; then
            echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸ"
            MERGE_SUCCESS=true
          else
            echo "âš ï¸ ç›´æ¥ãƒãƒ¼ã‚¸å¤±æ•—ã€auto-mergeã‚’è©¦è¡Œ..."
            gh pr merge $PR_NUMBER \
              --repo ${{ github.repository }} \
              --auto \
              --squash \
              --delete-branch && echo "âœ… Auto-mergeã‚’è¨­å®šã—ã¾ã—ãŸ"
            MERGE_SUCCESS=true
          fi
          
          # ãƒãƒ¼ã‚¸æˆåŠŸå¾Œã€é–¢é€£Issueã‚’ã‚¯ãƒ­ãƒ¼ã‚º
          if [ "$MERGE_SUCCESS" = "true" ]; then
            echo "ğŸ” é–¢é€£Issueã‚’æ¤œç´¢ã—ã¦ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™..."
            
            # Copilotãƒ©ãƒ™ãƒ«ãŒä»˜ã„ãŸæœ€æ–°ã®ã‚ªãƒ¼ãƒ—ãƒ³Issueã‚’æ¤œç´¢
            ISSUE_NUMBER=$(gh issue list --repo ${{ github.repository }} \
              --state open \
              --label "copilot-task" \
              --limit 1 \
              --json number \
              --jq '.[0].number')
            
            if [ ! -z "$ISSUE_NUMBER" ] && [ "$ISSUE_NUMBER" != "null" ]; then
              echo "ğŸ“ Issue #$ISSUE_NUMBER ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã™"
              gh issue close $ISSUE_NUMBER \
                --repo ${{ github.repository }} \
                --comment "âœ… PR #$PR_NUMBER ãŒãƒãƒ¼ã‚¸ã•ã‚ŒãŸãŸã‚ã€ã“ã®Issueã‚’è‡ªå‹•çš„ã«ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸã€‚"
              echo "âœ… Issue #$ISSUE_NUMBER ã‚’ã‚¯ãƒ­ãƒ¼ã‚ºã—ã¾ã—ãŸ"
            else
              echo "â„¹ï¸ é–¢é€£IssueãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            fi
          fi

