name: Auto Merge Copilot PR

on:
  workflow_run:
    workflows: ["Copilot coding agent"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    # Copilot coding agentãŒæˆåŠŸã—ãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Find and process Copilot PR
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: |
          echo "ğŸ” Copilot coding agentå®Œäº†ã€‚é–¢é€£PRã‚’æ¤œç´¢..."
          
          # Copilotãƒ–ãƒ©ãƒ³ãƒã®æœªãƒãƒ¼ã‚¸PRã‚’æ¤œç´¢ï¼ˆæœ€æ–°1ä»¶ã®ã¿ï¼‰
          PR_INFO=$(gh pr list --repo ${{ github.repository }} --state open --json number,headRefName,isDraft \
            | jq -r '[.[] | select(.headRefName | startswith("copilot/"))] | .[0]')
          
          if [ "$PR_INFO" = "null" ] || [ -z "$PR_INFO" ]; then
            echo "âš ï¸ Copilot PRãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi
          
          PR_NUMBER=$(echo "$PR_INFO" | jq -r '.number')
          IS_DRAFT=$(echo "$PR_INFO" | jq -r '.isDraft')
          
          echo "PR #$PR_NUMBER ã‚’æ¤œå‡º (Draft: $IS_DRAFT)"
          
          # Draft PRã®å ´åˆã¯ReadyåŒ–
          if [ "$IS_DRAFT" = "true" ]; then
            echo "ğŸ“ Draft PRã‚’Ready for Reviewã«å¤‰æ›´..."
            gh pr ready $PR_NUMBER --repo ${{ github.repository }}
            echo "âœ“ ReadyçŠ¶æ…‹ã«å¤‰æ›´ã—ã¾ã—ãŸ"
            sleep 5
          fi
          
          # æ‰¿èªã¯åˆ¥ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼(copilot-auto-approve.yml)ãŒè‡ªå‹•ã§è¡Œã†
          echo "â³ è‡ªå‹•æ‰¿èªã‚’å¾…æ©Ÿä¸­..."
          sleep 10
          
          # PRã‚’è‡ªå‹•ãƒãƒ¼ã‚¸
          echo "ğŸ”€ PRã‚’è‡ªå‹•ãƒãƒ¼ã‚¸ã—ã¾ã™: #$PR_NUMBER"
          if gh pr merge $PR_NUMBER \
            --repo ${{ github.repository }} \
            --squash \
            --delete-branch; then
            echo "âœ… è‡ªå‹•ãƒãƒ¼ã‚¸ãŒå®Œäº†ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ ç›´æ¥ãƒãƒ¼ã‚¸å¤±æ•—ã€auto-mergeã‚’è©¦è¡Œ..."
            gh pr merge $PR_NUMBER \
              --repo ${{ github.repository }} \
              --auto \
              --squash \
              --delete-branch && echo "âœ… Auto-mergeã‚’è¨­å®šã—ã¾ã—ãŸ"
          fi

