name: Deploy to FTP on Merge

on:
  pull_request:
    types: [closed]
    paths:
      - 'xserver/summaries/**/*.md'
      - 'xserver/index.html'
      - 'xserver/get_articles.php'
      - 'xserver/marked.min.js'

permissions:
  contents: read

jobs:
  deploy-to-ftp:
    # Pull RequestãŒãƒžãƒ¼ã‚¸ã•ã‚ŒãŸã¨ãã®ã¿FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install python-dotenv
      
      - name: Create .env file
        run: |
          echo "FTP_HOST=${{ secrets.FTP_HOST }}" >> .env
          echo "FTP_USER=${{ secrets.FTP_USER }}" >> .env
          echo "FTP_PASSWORD=${{ secrets.FTP_PASSWORD }}" >> .env
          echo "FTP_PORT=21" >> .env
          echo "FTP_REMOTE_PATH=/" >> .env
      
      - name: Upload to FTP
        run: |
          python -c "
          import ftplib
          import os
          from pathlib import Path
          from dotenv import load_dotenv
          
          load_dotenv()
          
          # FTPæŽ¥ç¶š
          ftp = ftplib.FTP()
          ftp.connect(os.getenv('FTP_HOST'), int(os.getenv('FTP_PORT', 21)))
          ftp.login(os.getenv('FTP_USER'), os.getenv('FTP_PASSWORD'))
          ftp.cwd('/')
          
          uploaded_count = 0
          
          # xserver/summariesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªé…ä¸‹ã‚’å†å¸°çš„ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          xserver_path = Path('xserver/summaries')
          if xserver_path.exists():
              for file_path in xserver_path.rglob('*.md'):
                  # ãƒªãƒ¢ãƒ¼ãƒˆãƒ‘ã‚¹ã‚’æ§‹ç¯‰ï¼ˆä¾‹: 2025/12/file.mdï¼‰
                  relative_path = file_path.relative_to(xserver_path)
                  remote_path = str(relative_path).replace('\\\\', '/')
                  
                  # å¿…è¦ã«å¿œã˜ã¦ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
                  remote_dirs = '/'.join(remote_path.split('/')[:-1])
                  if remote_dirs:
                      current_dir = ''
                      for dir_name in remote_dirs.split('/'):
                          current_dir = f'{current_dir}/{dir_name}' if current_dir else dir_name
                          try:
                              ftp.mkd(current_dir)
                          except:
                              pass  # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆ
                  
                  # ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                  with open(file_path, 'rb') as f:
                      ftp.storbinary(f'STOR {remote_path}', f)
                  print(f'âœ“ {remote_path} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ')
                  uploaded_count += 1
          
          # xserveré…ä¸‹ã®ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          for file_name in ['index.html', 'get_articles.php', 'marked.min.js']:
              file_path = Path(f'xserver/{file_name}')
              if file_path.exists():
                  with open(file_path, 'rb') as f:
                      ftp.storbinary(f'STOR {file_name}', f)
                  print(f'âœ“ {file_name} ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ')
                  uploaded_count += 1
          
          ftp.quit()
          
          print(f'\\nðŸ“¤ åˆè¨ˆ {uploaded_count} ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ')
          "
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull Request #${{ github.event.pull_request.number }} ã®ãƒžãƒ¼ã‚¸ã«ä¼´ã„ã€å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’XSERVERã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ å…¬é–‹URL: https://office8-inc.com/youtube-summaries/" >> $GITHUB_STEP_SUMMARY
