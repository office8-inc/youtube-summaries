name: Deploy to FTP on Merge

on:
  pull_request:
    types: [closed]
    paths:
      - 'xserver/summaries/**/*.md'
      - 'xserver/index.html'
      - 'xserver/get_articles.php'
      - 'xserver/marked.min.js'
  workflow_dispatch:
    inputs:
      deploy_all:
        description: 'å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆé€šå¸¸ã¯å¤‰æ›´åˆ†ã®ã¿ï¼‰'
        required: false
        type: boolean
        default: false

permissions:
  contents: read

jobs:
  deploy-to-ftp:
    # Pull RequestãŒãƒžãƒ¼ã‚¸ã•ã‚ŒãŸã¨ãã¾ãŸã¯Workflow Dispatchã§å®Ÿè¡Œ
    if: github.event_name == 'workflow_dispatch' || github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # å·®åˆ†æ¤œå‡ºã®ãŸã‚ç›´å‰ã®ã‚³ãƒŸãƒƒãƒˆã‚‚å–å¾—
      
      - name: Install lftp
        run: |
          sudo apt-get update
          sudo apt-get install -y lftp
      
      - name: Get changed files
        id: changed-files
        run: |
          if [ "${{ github.event.inputs.deploy_all }}" == "true" ]; then
            echo "mode=all" >> $GITHUB_OUTPUT
          else
            # PRãƒžãƒ¼ã‚¸æ™‚ã‚‚æ‰‹å‹•å®Ÿè¡Œæ™‚ã‚‚ã€æœ€æ–°ã‚³ãƒŸãƒƒãƒˆã®å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '^xserver/' || true)
            
            if [ -z "$CHANGED_FILES" ]; then
              echo "mode=none" >> $GITHUB_OUTPUT
              echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯ã‚ã‚Šã¾ã›ã‚“"
            else
              echo "mode=diff" >> $GITHUB_OUTPUT
              echo "$CHANGED_FILES" > changed_files.txt
              echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
              cat changed_files.txt
            fi
          fi
      
      - name: Upload to FTP (å·®åˆ†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰)
        if: steps.changed-files.outputs.mode != 'none'
        run: |
          # lftpã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ä½œæˆ
          cat > upload.lftp << 'EOF'
          set ftp:ssl-allow no
          set net:timeout 10
          set net:max-retries 3
          
          open ftp://${{ secrets.FTP_USER }}:${{ secrets.FTP_PASSWORD }}@${{ secrets.FTP_HOST }}
          
          EOF
          
          UPLOAD_COUNT=0
          
          if [ "${{ steps.changed-files.outputs.mode }}" == "all" ]; then
            echo "âš ï¸  å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰"
            
            # summariesé…ä¸‹ã®å…¨.mdãƒ•ã‚¡ã‚¤ãƒ«ã¨.jsonãƒ•ã‚¡ã‚¤ãƒ«
            while IFS= read -r file; do
              REMOTE_PATH="${file#xserver/summaries/}"
              REMOTE_DIR=$(dirname "$REMOTE_PATH")
              
              if [ "$REMOTE_DIR" != "." ]; then
                echo "mkdir -p $REMOTE_DIR" >> upload.lftp
              fi
              echo "put \"$file\" -o \"$REMOTE_PATH\"" >> upload.lftp
              echo "âœ“ $REMOTE_PATH ã‚’è¿½åŠ "
              UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
            done < <(find xserver/summaries \( -name "*.md" -o -name "*.json" \) -type f)
            
            # xserverç›´ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«
            for file in xserver/index.html xserver/get_articles.php xserver/marked.min.js; do
              if [ -f "$file" ]; then
                FILENAME=$(basename "$file")
                echo "put \"$file\" -o \"$FILENAME\"" >> upload.lftp
                echo "âœ“ $FILENAME ã‚’è¿½åŠ "
                UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              fi
            done
          else
            echo "ðŸ’¡ å·®åˆ†ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰"
            
            # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
            while IFS= read -r file; do
              if [[ "$file" == xserver/summaries/* ]]; then
                REMOTE_PATH="${file#xserver/summaries/}"
                REMOTE_DIR=$(dirname "$REMOTE_PATH")
                
                if [ "$REMOTE_DIR" != "." ]; then
                  echo "mkdir -p $REMOTE_DIR" >> upload.lftp
                fi
                echo "put \"$file\" -o \"$REMOTE_PATH\"" >> upload.lftp
                echo "âœ“ $REMOTE_PATH ã‚’è¿½åŠ  (å¤‰æ›´æ¤œå‡º)"
                UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              elif [[ "$file" == xserver/* ]]; then
                FILENAME=$(basename "$file")
                echo "put \"$file\" -o \"$FILENAME\"" >> upload.lftp
                echo "âœ“ $FILENAME ã‚’è¿½åŠ  (å¤‰æ›´æ¤œå‡º)"
                UPLOAD_COUNT=$((UPLOAD_COUNT + 1))
              fi
            done < changed_files.txt
          fi
          
          echo "bye" >> upload.lftp
          
          # lftpã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
          if [ $UPLOAD_COUNT -gt 0 ]; then
            echo ""
            echo "ðŸ“¤ FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."
            lftp -f upload.lftp
            echo ""
            echo "âœ… $UPLOAD_COUNT ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸  ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¯¾è±¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "## ðŸ“Š FTPã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Pull Request #${{ github.event.pull_request.number }} ã®ãƒžãƒ¼ã‚¸ã«ä¼´ã„ã€å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’XSERVERã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸã€‚" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ å…¬é–‹URL: https://office8-inc.com/youtube-summaries/" >> $GITHUB_STEP_SUMMARY
